<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poly Maker Dashboard</title>
    <base href="/poly-maker/">
    <link rel="stylesheet" href="static/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header-row">
        <h1>Poly Maker Dashboard</h1>
        <a id="total-pnl" class="pill" href="pnl" title="View per-trade PnL">PnL: —</a>
      </div>

      <section>
        <h2>Open Orders</h2>
        <table id="orders">
          <thead>
            <tr>
              <th>Market</th>
              <th>Outcome</th>
              <th>Side</th>
              <th>Price</th>
              <th>Orig Size</th>
              <th>Matched</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="orders-pagination"></div>
      </section>

      <section>
        <h2>Positions</h2>
        <div class="action-group" id="positions-filters">
          <a href="#" id="toggle-selected-only" class="pill">Selected Only: Off</a>
        </div>
        <table id="positions">
          <thead>
            <tr>
              <th>Market</th>
              <th>Outcome</th>
              <th>Size</th>
              <th>Avg Price</th>
              <th>Cur Price</th>
              <th>PnL %</th>
              <th>Close 25% / 50% / 100%</th>
            </tr>
          </thead>
          <tbody id="positions-tbody"></tbody>
        </table>
      </section>

      <section>
        <h2>Last Trades</h2>
        <table id="trades">
          <thead>
            <tr>
              <th>Market</th>
              <th>Outcome</th>
              <th>Side</th>
              <th>Shares</th>
              <th>Price</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
      </section>
    </div>

    <script>
      async function fetchJson(url) {
        const res = await fetch(url, { cache: 'no-store', credentials: 'same-origin' });
        if (!res.ok) throw new Error('Request failed: ' + url);
        return res.json();
      }

      function setRows(tbody, rows, columns) {
        tbody.innerHTML = '';
        
        for (const row of rows) {
          const tr = document.createElement('tr');
          for (const c of columns) {
            const td = document.createElement('td');
            let v = row[c];
            if (typeof v === 'number') {
              v = Math.abs(v) > 1e6 ? v.toFixed(2) : v;
            }
            td.textContent = v == null ? '' : v;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
      }

      function setPositionRows(tbody, rows) {
        tbody.innerHTML = '';
        for (const row of rows) {
          const tr = document.createElement('tr');
          const cols = ['market_name', 'outcome', 'size', 'avgPrice', 'curPrice', 'percentPnl'];
          for (const c of cols) {
            const td = document.createElement('td');
            const v = row[c];
            td.textContent = v == null ? '' : (typeof v === 'number' ? v : String(v));
            tr.appendChild(td);
          }

          const actions = document.createElement('td');
          actions.className = 'actions-cell';

          const group = document.createElement('div');
          group.className = 'action-group';

          // Pills: 25%, 50%, 100%, Market
          const tokenId = row.asset;
          function makePill(label, fraction, price) {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'pill';
            a.textContent = label;
            a.addEventListener('click', async (e) => {
              e.preventDefault();
              try {
                const payload = { token_id: tokenId };
                if (typeof fraction === 'number') payload.fraction = fraction;
                if (price !== undefined) payload.price = price; // can be null
                const res = await fetch('api/positions/close', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'same-origin',
                  body: JSON.stringify(payload),
                });
                if (!res.ok) throw new Error('Close request failed');
                await loadPositions();
                await loadPnl();
              } catch (err) {
                console.error(err);
              }
            });
            return a;
          }

          group.appendChild(makePill('25%', 0.25));
          group.appendChild(makePill('50%', 0.5));
          group.appendChild(makePill('100%', 1.0));

          actions.appendChild(group);
          tr.appendChild(actions);
          tbody.appendChild(tr);
        }
      }

      let tradePage = 1;
      let ordersPage = 1;
      const tradesPerPage = 10;
      const ordersPerPage = 10;

      function makeButton(label, page, disabled=false, active=false) {
        const btn = document.createElement('button');
        btn.textContent = label;
        if (disabled) btn.disabled = true;
        if (active) btn.className = 'active';
        if (!disabled && !active && typeof page === 'number') {
          btn.addEventListener('click', () => { tradePage = page; loadTrades(); });
        }
        return btn;
      }

      function renderPagination(totalPages) {
        const container = document.getElementById('pagination');
        container.innerHTML = '';
        // Prev
        container.appendChild(makeButton('<', tradePage - 1, tradePage <= 1));

        const pages = [];
        if (totalPages <= 5) {
          for (let p = 1; p <= totalPages; p++) pages.push(p);
        } else {
          pages.push(1);
          if (tradePage > 3) pages.push('…');
          const start = Math.max(2, tradePage - 1);
          const end = Math.min(totalPages - 1, tradePage + 1);
          for (let p = start; p <= end; p++) pages.push(p);
          if (tradePage < totalPages - 2) pages.push('…');
          pages.push(totalPages);
        }

        for (const p of pages) {
          if (p === '…') {
            const span = document.createElement('span');
            span.textContent = '…';
            container.appendChild(span);
          } else {
            container.appendChild(makeButton(String(p), p, false, p === tradePage));
          }
        }

        // Next
        container.appendChild(makeButton('>', tradePage + 1, tradePage >= totalPages));
      }

      function renderOrdersPagination(totalPages) {
        const container = document.getElementById('orders-pagination');
        container.innerHTML = '';
        // Prev
        container.appendChild((() => {
          const btn = document.createElement('button');
          btn.textContent = '<';
          if (ordersPage <= 1) btn.disabled = true;
          if (!btn.disabled) btn.addEventListener('click', () => { ordersPage = ordersPage - 1; loadOrders(); });
          return btn;
        })());

        const pages = [];
        if (totalPages <= 5) {
          for (let p = 1; p <= totalPages; p++) pages.push(p);
        } else {
          pages.push(1);
          if (ordersPage > 3) pages.push('…');
          const start = Math.max(2, ordersPage - 1);
          const end = Math.min(totalPages - 1, ordersPage + 1);
          for (let p = start; p <= end; p++) pages.push(p);
          if (ordersPage < totalPages - 2) pages.push('…');
          pages.push(totalPages);
        }

        for (const p of pages) {
          if (p === '…') {
            const span = document.createElement('span');
            span.textContent = '…';
            container.appendChild(span);
          } else {
            const btn = document.createElement('button');
            btn.textContent = String(p);
            if (p === ordersPage) btn.className = 'active';
            if (p !== ordersPage) btn.addEventListener('click', () => { ordersPage = p; loadOrders(); });
            container.appendChild(btn);
          }
        }

        // Next
        container.appendChild((() => {
          const btn = document.createElement('button');
          btn.textContent = '>';
          if (ordersPage >= totalPages) btn.disabled = true;
          if (!btn.disabled) btn.addEventListener('click', () => { ordersPage = ordersPage + 1; loadOrders(); });
          return btn;
        })());
      }

      async function loadPnl() {
        try {
          const pnl = await fetchJson('api/pnl');
          const pill = document.getElementById('total-pnl');
          const total = pnl && typeof pnl.total === 'number' ? pnl.total : 0;
          const sign = total > 0 ? '+' : '';
          pill.textContent = `PnL: ${sign}${total.toFixed(2)}`;
          pill.classList.remove('green', 'red');
          pill.classList.add(total >= 0 ? 'green' : 'red');
        } catch (e) {
          console.error(e);
        }
      }

      async function loadOrders() {
        try {
          const orders = await fetchJson(`api/orders?limit=${ordersPerPage}&page=${ordersPage}`);
          setRows(document.querySelector('#orders tbody'), orders.data || [], [
            'market_name', 'outcome', 'side', 'price', 'original_size', 'size_matched', 'status'
          ]);
          const totalOrderPages = orders.total ? Math.max(1, Math.ceil(orders.total / ordersPerPage)) : 1;
          renderOrdersPagination(totalOrderPages);
        } catch (e) {
          console.error(e);
        }
      }

      let selectedOnly = false;

      async function loadPositions() {
        try {
          const url = selectedOnly ? 'api/positions?selected_only=true' : 'api/positions';
          const positions = await fetchJson(url);
          setPositionRows(
            document.querySelector('#positions-tbody'),
            positions.data || []
          );
        } catch (e) {
          console.error(e);
        }
      }

      async function loadTrades() {
        try {
          const trades = await fetchJson(`api/trades?limit=${tradesPerPage}&page=${tradePage}`);
          setRows(document.querySelector('#trades tbody'), trades.data || [], [
            'market_name', 'outcome', 'side', 'size', 'price', 'datetime'
          ]);
          const totalPages = trades.total ? Math.max(1, Math.ceil(trades.total / tradesPerPage)) : 1;
          renderPagination(totalPages);
        } catch (e) {
          console.error(e);
        }
      }

      // Setup page
      document.addEventListener('DOMContentLoaded', () => {});

      // Initial load
      loadOrders();
      loadPositions();
      loadTrades();
      loadPnl();

      // Rotate updates every 5s: orders -> positions -> trades -> repeat
      let cycleIndex = 0;
      let isTicking = false;
      setInterval(async () => {
        if (isTicking) return;
        isTicking = true;
        try {
          if (cycleIndex % 3 === 0) {
            await loadOrders();
          } else if (cycleIndex % 3 === 1) {
            await loadPositions();
          } else {
            await loadTrades();
          }
          cycleIndex += 1;
        } catch (e) {
          console.error(e);
        } finally {
          isTicking = false;
        }
      }, 5000);

      // PnL refresh every 60 seconds
      setInterval(() => { loadPnl(); }, 60000);

      // Positions filter toggle
      document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('toggle-selected-only');
        if (toggle) {
          toggle.addEventListener('click', async (e) => {
            e.preventDefault();
            selectedOnly = !selectedOnly;
            toggle.textContent = `Selected Only: ${selectedOnly ? 'On' : 'Off'}`;
            await loadPositions();
          });
        }
      });
    </script>
  </body>
</html>


